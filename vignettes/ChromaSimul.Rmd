---
title: "Chroma simulation and peak detection"
output: html_notebook
---


```{r, echo=FALSE}
library(GCalignR)
library(ggplot2)
```

Chromatograms are simulated by picking pre-defined peaks from the allways same population. Chromatograms differ in the number of substances, their concentration and retention times. Variation in retention times was introduced by systematically shifting whole chromatograms in the order of samples.

```{r, results='hide'}
set.seed(123)
peak_list <- sample(x = seq(from = 0, to = 26, by = 4), size = 6, replace = F)
df <- GCalignR:::simple_chroma(peaks = peak_list, N = 4)
```

An overlay of all chromatograms shows a considerable variation in peak retention times in form of shifts of the peak maxima. 

```{r}
# draw chromatograms and display peaks
chroma <- ggplot(data = df, aes(x,y, col = sample, fill = sample)) + geom_line(size = 1) + theme_classic() + xlab("Retention time\n [Minutes]") + ylab("Intensity") + scale_x_continuous(breaks = seq(0,30,5),expand = c(0,0)) + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + scale_color_brewer(palette = "Dark2")

# peaks are in this case simply the local maxima for each sample
peaks <- GCalignR:::find_peaks(df)
chroma <- chroma + geom_linerange(data = peaks, aes(x = x, ymin = y, ymax = y + 0.1), linetype = "solid", col = "black") + annotate("text", x = peaks[["x"]], y = peaks[["y"]] + 0.2, label = as.character(round(peaks[["x"]],2)), angle = 90)
print(chroma)
```
Using standard peak detection software, a list of peaks can be generated for every chromatogram. As the here simulated data consists of peaks modelled by perfect gaussian distribution, we can simply characterise each peak by searching for the local maxima using a custom script.

```{r, eval=F}
peaks <- GCalignR:::find_peaks(df)
ggplot(data = peaks, aes(col = sample, size = 0.7)) + geom_linerange(aes(x = x, ymin = 0, ymax = y)) + facet_wrap(~sample, nrow = 4) + theme_classic() + xlab("Retention time\n [Minutes]") + ylab("Intensity") + scale_x_continuous(breaks = seq(0,60,5),expand = c(0.1,0.1)) + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + theme(legend.position = "none") + scale_color_brewer(palette = "Dark2")
```

Formatting for aligning with `GCalignR`

```{r}
sink("ChromSimul.txt",append = FALSE)
# write sample identifier
cat(levels(peaks[["sample"]]),sep = "\t")
# write variables
cat(c("\nrt","height\n"),sep = "\t")
# merge data horizontally

dat_mat <- numeric()

for (i in levels(peaks[["sample"]])) {
    temp <- as.matrix(peaks[,c("x","y")][peaks[["sample"]] == i,])
    add <-  max(summary(peaks[["sample"]])) - nrow(temp)
    temp <- rbind(temp, matrix(data = 0,nrow = add, ncol = 2))
      dat_mat <- cbind(dat_mat, temp)
} 
write.table(dat_mat, row.names = F, col.names = F, sep = "\t")
sink()
```

```{r}
res <- align_chromatograms(data = "ChromSimul.txt", rt_col_name = "rt", max_linear_shift = 2, max_diff_peak2mean = 0.02, min_diff_peak2peak = 1, reference = "A2")
```
```{r}
plot(res, breaks = seq(-1.4,1.4,0.2), which_plot = "s", ylim = seq(0,1,1))
print(res[["Logfile"]])
```

```{r, eval=FALSE}
chroma <- ggplot(data = df, aes(x,y)) + geom_line() + theme_classic() + xlab("Retention time\n [Minutes]") + ylab("Intensity") + scale_x_continuous(breaks = seq(0,60,5),expand = c(0,0)) + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + facet_wrap(facets = ~sample, nrow = 4)
chroma
chroma + geom_linerange(aes(x = x,ymin = 0, ymax = y), data = peaks, col = "blue", linetype = "dotted", size = 1.2)
```
